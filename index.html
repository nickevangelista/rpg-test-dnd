<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Manager - Auto API</title>
    <style>
        :root {
            --bg-color: #121214;
            --card-bg: #202024;
            --accent: #8257e5; /* Roxo M√≠stico */
            --accent-hover: #9466ff;
            --text: #e1e1e6;
            --text-secondary: #a8a8b3;
            --danger: #e54c4c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0; padding: 20px; padding-bottom: 80px;
        }

        h1, h2, h3 { margin: 0; }
        
        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #323238;
        }
        .char-info h1 { font-size: 1.5em; color: var(--accent); }
        .char-info p { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card-bg); padding: 15px; border-radius: 8px;
            text-align: center; border: 1px solid #323238;
        }
        .stat-val { display: block; font-size: 1.4em; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.75em; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        /* Slots System */
        .slots-container { margin-bottom: 30px; }
        .slot-row {
            display: flex; align-items: center; margin-bottom: 12px;
            background: var(--card-bg); padding: 10px; border-radius: 6px;
        }
        .slot-label { width: 60px; font-weight: bold; font-size: 0.9em; color: var(--text-secondary); }
        .slot-bubbles { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
        .bubble {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid var(--accent); cursor: pointer; transition: 0.2s;
        }
        .bubble.spent { background: transparent; border-color: #444; }
        .bubble.ready { background: var(--accent); box-shadow: 0 0 8px rgba(130, 87, 229, 0.4); }

        /* Spell List */
        .spell-list { list-style: none; padding: 0; }
        .spell-card {
            background: var(--card-bg); border-left: 3px solid var(--accent);
            margin-bottom: 12px; padding: 15px; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .spell-main h3 { font-size: 1em; color: #fff; }
        .spell-meta { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
        
        /* Buttons */
        button { border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-icon { background: #323238; color: #fff; padding: 8px 12px; }
        .btn-main { background: var(--accent); color: white; width: 100%; padding: 12px; margin-bottom: 15px; }
        .btn-main:hover { background: var(--accent-hover); }
        .btn-cast { background: var(--accent); color: white; padding: 6px 12px; font-size: 0.8em; }
        .btn-cast:disabled { background: #323238; color: #666; cursor: not-allowed; }
        .btn-danger { background: rgba(229, 76, 76, 0.1); color: var(--danger); width: 100%; padding: 10px; margin-top: 20px;}

        /* Modal & Form */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #202024; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 450px; position: relative;
        }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 12px; background: #121214; border: 1px solid #323238;
            color: white; border-radius: 6px; box-sizing: border-box;
        }
        
        /* Loading Overlay */
        #loading {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; color: var(--accent);
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #333; border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Auto-complete List */
        #spell-suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #2d2d35; border: 1px solid #444;
            max-height: 150px; overflow-y: auto; z-index: 10;
            border-radius: 0 0 6px 6px; display: none;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #333; }
        .suggestion-item:hover { background: #383840; }

    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <span id="loading-text">Conectando √† Trama M√°gica...</span>
</div>

<div class="container">
    <header>
        <div class="char-info">
            <h1 id="char-name">Nome</h1>
            <p><span id="char-class">Classe</span> Nvl <span id="char-level">1</span></p>
        </div>
        <button class="btn-icon" onclick="openCharModal()">‚öôÔ∏è Ajustes</button>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-val" id="hp-display">--</span>
            <span class="stat-label">HP M√°x</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="dc-display">--</span>
            <span class="stat-label">DC Magia</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="mod-display">--</span>
            <span class="stat-label">Atk Magia</span>
        </div>
    </div>

    <button class="btn-main" style="background:#333;" onclick="longRest()">üí§ Descanso Longo</button>

    <div id="slots-container" class="slots-container"></div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>Grim√≥rio</h2>
        <span style="font-size:0.8em; color:#666">Powered by D&D 5e API</span>
    </div>
    
    <button class="btn-main" onclick="openSpellModal()">+ Nova Magia (API)</button>
    
    <ul id="spell-list" class="spell-list"></ul>
    
    <button class="btn-danger" onclick="hardReset()">‚ö†Ô∏è Resetar Personagem</button>
</div>

<div id="modal-char" class="modal">
    <div class="modal-content">
        <h3>Level Up & Dados</h3>
        <p style="font-size:0.8em; color:#aaa; margin-bottom:15px">Alterar o n√≠vel ou classe buscar√° a tabela de slots automaticamente.</p>
        
        <div class="input-group">
            <label>Nome</label>
            <input type="text" id="edit-name">
        </div>
        
        <div class="input-group" style="display:flex; gap:10px">
            <div style="flex:1">
                <label>Classe (Ingl√™s)</label>
                <select id="edit-class">
                    <option value="bard">Bard</option>
                    <option value="wizard">Wizard</option>
                    <option value="sorcerer">Sorcerer</option>
                    <option value="cleric">Cleric</option>
                    <option value="druid">Druid</option>
                    <option value="warlock">Warlock</option>
                    <option value="paladin">Paladin</option>
                    <option value="ranger">Ranger</option>
                </select>
            </div>
            <div style="flex:1">
                <label>N√≠vel</label>
                <input type="number" id="edit-level" min="1" max="20">
            </div>
        </div>

        <div class="input-group">
            <label>HP M√°ximo</label>
            <input type="number" id="edit-hp">
        </div>
        
        <div class="input-group" style="display:flex; gap:10px">
            <div>
                <label>DC (Save)</label>
                <input type="number" id="edit-dc">
            </div>
            <div>
                <label>Mod. Atk</label>
                <input type="number" id="edit-mod">
            </div>
        </div>

        <button class="btn-main" onclick="saveCharData()">Salvar e Atualizar</button>
        <button class="btn-main" style="background:transparent; border:1px solid #444;" onclick="closeModal('modal-char')">Cancelar</button>
    </div>
</div>

<div id="modal-spell" class="modal">
    <div class="modal-content">
        <h3>Aprender Nova Magia</h3>
        
        <div class="input-group">
            <label>Buscar na API (Nome em Ingl√™s)</label>
            <input type="text" id="api-search" placeholder="Ex: Fireball" onkeyup="filterSpells()">
            <div id="spell-suggestions"></div>
        </div>

        <div id="spell-details-preview" style="display:none; background:#121214; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #333;">
            <p style="color:var(--accent); font-weight:bold; margin:0 0 5px 0" id="preview-name">Magic Name</p>
            <p style="font-size:0.8em; color:#aaa; margin:0" id="preview-meta">Level 3 ‚Ä¢ Evocation</p>
            <p style="font-size:0.8em; margin:5px 0 0 0" id="preview-desc">Description...</p>
        </div>

        <input type="hidden" id="final-spell-name">
        <input type="hidden" id="final-spell-level">
        <input type="hidden" id="final-spell-desc">

        <button class="btn-main" id="btn-add-spell" onclick="confirmAddSpell()" disabled>Adicionar ao Grim√≥rio</button>
        <button class="btn-main" style="background:transparent; border:1px solid #444;" onclick="closeModal('modal-spell')">Cancelar</button>
    </div>
</div>

<script>
    // --- API Configuration ---
    const API_BASE = 'https://www.dnd5eapi.co/api';
    let apiSpellList = []; // Cache da lista de magias

    // --- State ---
    const defaultData = {
        name: "Tav",
        classIndex: "bard", // Usar o index da API (letras minusculas)
        className: "Bard",
        level: 1,
        stats: { hp: 10, dc: 13, mod: 5 },
        slotsMax: { 1: 2, 2: 0, 3: 0, 4: 0, 5: 0, 6:0, 7:0, 8:0, 9:0 },
        slotsSpent: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6:0, 7:0, 8:0, 9:0 },
        spells: []
    };
    let data = {};

    // --- Initialization ---
    async function init() {
        loadLocalData();
        render();
        
        // Background load: Lista de magias para o search
        if(apiSpellList.length === 0) {
            try {
                const response = await fetch(`${API_BASE}/spells`);
                const result = await response.json();
                apiSpellList = result.results; // Array com {index, name, url}
                console.log("API: Lista de magias carregada.", apiSpellList.length);
            } catch (e) {
                console.error("Erro ao carregar API", e);
            }
        }
    }

    function loadLocalData() {
        const saved = localStorage.getItem('rpgSheetPro');
        if (saved) {
            data = JSON.parse(saved);
        } else {
            data = JSON.parse(JSON.stringify(defaultData));
        }
    }

    function saveData() {
        localStorage.setItem('rpgSheetPro', JSON.stringify(data));
        render();
    }

    // --- API Logic: Class Progression ---
    async function updateClassSlotsFromAPI() {
        showLoading(true, "Consultando tabelas de classe...");
        try {
            // Ex: https://www.dnd5eapi.co/api/classes/bard/levels/5
            const url = `${API_BASE}/classes/${data.classIndex}/levels/${data.level}`;
            const res = await fetch(url);
            
            if(!res.ok) throw new Error("Classe/N√≠vel n√£o encontrado na API");
            
            const levelData = await res.json();
            
            // Atualizar slots se tiver spellcasting
            if (levelData.spellcasting) {
                const slots = levelData.spellcasting;
                // A API retorna algo como: { spell_slots_level_1: 4, spell_slots_level_2: 3 ... }
                
                // Resetar slots maximos
                for(let i=1; i<=9; i++) data.slotsMax[i] = 0;

                // Mapear retorno da API para nosso formato
                if(slots.spell_slots_level_1) data.slotsMax[1] = slots.spell_slots_level_1;
                if(slots.spell_slots_level_2) data.slotsMax[2] = slots.spell_slots_level_2;
                if(slots.spell_slots_level_3) data.slotsMax[3] = slots.spell_slots_level_3;
                if(slots.spell_slots_level_4) data.slotsMax[4] = slots.spell_slots_level_4;
                if(slots.spell_slots_level_5) data.slotsMax[5] = slots.spell_slots_level_5;
                if(slots.spell_slots_level_6) data.slotsMax[6] = slots.spell_slots_level_6;
                if(slots.spell_slots_level_7) data.slotsMax[7] = slots.spell_slots_level_7;
                if(slots.spell_slots_level_8) data.slotsMax[8] = slots.spell_slots_level_8;
                if(slots.spell_slots_level_9) data.slotsMax[9] = slots.spell_slots_level_9;

                alert(`N√≠vel Atualizado! Slots sincronizados com a tabela de ${data.className}.`);
            } else {
                alert("Essa classe n√£o possui Spellcasting nativo ou a API n√£o retornou slots (ex: Warlock funciona diferente).");
            }
            saveData();

        } catch (error) {
            alert("Erro ao buscar dados da classe na API: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    // --- API Logic: Spell Search ---
    function filterSpells() {
        const input = document.getElementById('api-search').value.toLowerCase();
        const suggestionsBox = document.getElementById('spell-suggestions');
        suggestionsBox.innerHTML = '';
        
        if(input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const filtered = apiSpellList.filter(s => s.name.toLowerCase().includes(input)).slice(0, 10);
        
        if(filtered.length > 0) {
            suggestionsBox.style.display = 'block';
            filtered.forEach(spell => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = spell.name;
                div.onclick = () => fetchSpellDetails(spell.url);
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    }

    async function fetchSpellDetails(url) {
        showLoading(true, "Decifrando pergaminho...");
        document.getElementById('spell-suggestions').style.display = 'none';
        
        try {
            const res = await fetch(`https://www.dnd5eapi.co${url}`);
            const spell = await res.json();
            
            // Preencher Preview
            document.getElementById('api-search').value = spell.name;
            document.getElementById('preview-name').innerText = spell.name;
            
            let desc = spell.desc[0]; // Pega o primeiro paragrafo
            const levelText = spell.level === 0 ? "Truque (Cantrip)" : `N√≠vel ${spell.level}`;
            const school = spell.school.name;
            
            document.getElementById('preview-meta').innerText = `${levelText} ‚Ä¢ ${school}`;
            document.getElementById('preview-desc').innerText = desc.substring(0, 100) + "...";
            document.getElementById('spell-details-preview').style.display = 'block';

            // Preparar dados para salvar
            document.getElementById('final-spell-name').value = spell.name;
            document.getElementById('final-spell-level').value = spell.level;
            document.getElementById('final-spell-desc').value = desc;
            
            document.getElementById('btn-add-spell').disabled = false;
            document.getElementById('btn-add-spell').innerText = "Aprender " + spell.name;

        } catch(e) {
            alert("Erro ao puxar detalhes da magia.");
        } finally {
            showLoading(false);
        }
    }

    // --- Core Logic ---
    
    function saveCharData() {
        const oldClass = data.classIndex;
        const oldLevel = data.level;

        data.name = document.getElementById('edit-name').value;
        const selectClass = document.getElementById('edit-class');
        data.classIndex = selectClass.value;
        data.className = selectClass.options[selectClass.selectedIndex].text;
        
        data.level = parseInt(document.getElementById('edit-level').value);
        data.stats.hp = parseInt(document.getElementById('edit-hp').value);
        data.stats.dc = parseInt(document.getElementById('edit-dc').value);
        data.stats.mod = parseInt(document.getElementById('edit-mod').value);

        closeModal('modal-char');
        saveData();

        // Se mudou classe ou n√≠vel, pergunta se quer atualizar slots
        if(oldClass !== data.classIndex || oldLevel !== data.level) {
            if(confirm("Mudan√ßa de N√≠vel/Classe detectada. Deseja atualizar seus Slots automaticamente pela API?")) {
                updateClassSlotsFromAPI();
            }
        }
    }

    function confirmAddSpell() {
        const name = document.getElementById('final-spell-name').value;
        const level = parseInt(document.getElementById('final-spell-level').value);
        const desc = document.getElementById('final-spell-desc').value;

        data.spells.push({ id: Date.now(), name, level, desc });
        saveData();
        closeModal('modal-spell');
        
        // Reset Modal
        document.getElementById('api-search').value = '';
        document.getElementById('spell-details-preview').style.display = 'none';
        document.getElementById('btn-add-spell').disabled = true;
    }

    function castSpell(level) {
        if(level === 0) return;
        if(data.slotsSpent[level] < data.slotsMax[level]) {
            data.slotsSpent[level]++;
            saveData();
        }
    }

    function toggleSlot(level, index) {
        const available = data.slotsMax[level] - data.slotsSpent[level];
        if(index < available) data.slotsSpent[level]++;
        else data.slotsSpent[level]--;
        saveData();
    }

    function removeSpell(index) {
        if(confirm("Esquecer esta magia?")) {
            data.spells.splice(index, 1);
            saveData();
        }
    }

    function longRest() {
        if(confirm("Fazer descanso longo?")) {
            for(let i in data.slotsSpent) data.slotsSpent[i] = 0;
            saveData();
        }
    }

    function hardReset() {
        if(confirm("Apagar TUDO?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- Render ---
    function render() {
        // Header
        document.getElementById('char-name').innerText = data.name;
        document.getElementById('char-class').innerText = data.className;
        document.getElementById('char-level').innerText = data.level;
        document.getElementById('hp-display').innerText = data.stats.hp;
        document.getElementById('dc-display').innerText = data.stats.dc;
        document.getElementById('mod-display').innerText = "+" + data.stats.mod;

        // Slots
        const container = document.getElementById('slots-container');
        container.innerHTML = '';
        let hasSlots = false;
        
        for(let i=1; i<=9; i++) {
            if(data.slotsMax[i] > 0) {
                hasSlots = true;
                const row = document.createElement('div');
                row.className = 'slot-row';
                
                let bubblesHtml = '';
                const available = data.slotsMax[i] - data.slotsSpent[i];
                
                for(let j=0; j<data.slotsMax[i]; j++) {
                    const status = j < available ? 'ready' : 'spent';
                    bubblesHtml += `<div class="bubble ${status}" onclick="toggleSlot(${i}, ${j})"></div>`;
                }

                row.innerHTML = `
                    <div class="slot-label">N√≠vel ${i}</div>
                    <div class="slot-bubbles">${bubblesHtml}</div>
                `;
                container.appendChild(row);
            }
        }
        if(!hasSlots) container.innerHTML = `<p style="text-align:center; color:#555">Sem slots. V√° em Ajustes e defina sua classe/n√≠vel.</p>`;

        // Spells
        const list = document.getElementById('spell-list');
        list.innerHTML = '';
        data.spells.sort((a,b) => a.level - b.level);
        
        data.spells.forEach((spell, idx) => {
            const li = document.createElement('li');
            li.className = 'spell-card';
            
            const lvlLabel = spell.level === 0 ? "Truque" : `N√≠vel ${spell.level}`;
            const canCast = spell.level === 0 || (data.slotsMax[spell.level] - data.slotsSpent[spell.level] > 0);
            
            li.innerHTML = `
                <div class="spell-main">
                    <h3>${spell.name}</h3>
                    <div class="spell-meta">${lvlLabel}</div>
                </div>
                <div>
                    <button class="btn-cast" onclick="castSpell(${spell.level})" 
                        ${!canCast ? 'disabled' : ''}>
                        ${spell.level === 0 ? '‚ôæÔ∏è' : 'Gastar'}
                    </button>
                    <button onclick="removeSpell(${idx})" style="background:none; color:#555; margin-left:5px;">&times;</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // --- Utils ---
    function showLoading(show, text="") {
        const el = document.getElementById('loading');
        if(show) {
            document.getElementById('loading-text').innerText = text;
            el.style.display = 'flex';
        } else {
            el.style.display = 'none';
        }
    }

    function openCharModal() {
        document.getElementById('edit-name').value = data.name;
        // Tentar selecionar a classe certa
        const sel = document.getElementById('edit-class');
        sel.value = data.classIndex || 'bard';
        
        document.getElementById('edit-level').value = data.level;
        document.getElementById('edit-hp').value = data.stats.hp;
        document.getElementById('edit-dc').value = data.stats.dc;
        document.getElementById('edit-mod').value = data.stats.mod;
        document.getElementById('modal-char').style.display = 'flex';
    }
    
    function openSpellModal() { document.getElementById('modal-spell').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Start
    init();

</script>
</body>
</html>